<!DOCTYPE html>
<!-- 
  CAMPUS CURSO · SIMAQ v3.5 (Carga Instantánea y Robusta)
  -------------------------------------------------------------------
  - FIX DEFINITIVO: Se soluciona el problema de la página "Cargando...".
  - LÓGICA REESCRITA: La página ahora muestra la estructura del curso instantáneamente y carga el progreso del usuario en segundo plano.
  - UX MEJORADA: Se elimina cualquier posibilidad de que la página se congele esperando una respuesta de la base de datos.
  -------------------------------------------------------------------
-->
<html lang="es-CL">
<head>
    <meta charset="UTF-8" />
    <title>Lección del Curso - SIMAQ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="Plataforma de aprendizaje de SIMAQ.">
    <link rel="icon" href="https://bmeryu.github.io/SIMAQ/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="https://bmeryu.github.io/SIMAQ/Logo_SIMAQ.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.368.0/dist/umd/lucide.min.js"></script>
    <style>
        :root {
            --simaq-blue: #0057FF;
            --simaq-dark-blue: #003db3;
        }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .text-simaq-blue { color: var(--simaq-blue); }
        .bg-simaq-blue { background-color: var(--simaq-blue); }
        .border-simaq-blue { border-color: var(--simaq-blue); }
        .ring-simaq-blue { --tw-ring-color: var(--simaq-blue); }
        
        .quiz-option.selected { 
            border-color: var(--simaq-blue); 
            background-color: #eff6ff; 
            --tw-ring-color: var(--simaq-blue);
            box-shadow: 0 0 0 2px var(--simaq-blue);
        }

        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary .arrow-down { transform: rotate(180deg); }
        .arrow-down { transition: transform 0.2s ease-in-out; }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="flex flex-col min-h-screen">
        <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 shadow-sm">
            <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
                <a href="index.html" class="flex items-center" aria-label="Página de inicio de SIMAQ">
                    <img src="https://bmeryu.github.io/SIMAQ/Logo_SIMAQ.png" alt="Logo de SIMAQ" class="h-16 md:h-20 w-auto">
                </a>
                <div class="flex items-center gap-2 sm:gap-4">
                    <div id="user-profile-container" class="hidden items-center gap-3 relative">
                        <span class="font-semibold text-gray-700 hidden sm:block" id="user-name"></span>
                        <button id="logout-button" class="text-sm text-gray-500 hover:text-red-600 font-medium transition-colors">Cerrar sesión</button>
                    </div>
                </div>
            </nav>
        </header>

        <main class="flex-1 flex flex-col lg:flex-row overflow-hidden">
            <aside id="course-sidebar" class="w-full lg:w-80 xl:w-96 bg-white border-r border-slate-200 flex-shrink-0 overflow-y-auto">
                <div class="p-6">
                    <a href="./campus-simaq.html" class="text-sm text-simaq-blue hover:text-simaq-dark-blue font-semibold flex items-center mb-4"><i data-lucide="arrow-left" class="h-4 w-4 mr-2"></i>Volver a Mis Cursos</a>
                    <h1 id="course-title" class="text-2xl font-bold text-gray-900">Cargando...</h1>
                    <div id="progress-container" class="mt-4">
                        <div class="flex justify-between text-sm font-medium text-gray-600 mb-1"><span>Progreso</span><span id="progress-text">0%</span></div>
                        <div class="w-full bg-slate-200 rounded-full h-2-5"><div id="progress-bar" class="bg-simaq-blue h-2-5 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                    </div>
                </div>
                <nav id="modules-container" class="space-y-1 px-2 pb-6"></nav>
            </aside>

            <section id="lesson-content" class="flex-1 bg-slate-50 overflow-y-auto">
                <div class="p-6 md:p-8 lg:p-10 max-w-4xl mx-auto">
                    <h2 id="lesson-title" class="text-3xl font-bold text-gray-900 mb-8">Cargando...</h2>
                    <div id="lesson-material-container" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <!-- El contenido se inyecta aquí -->
                    </div>
                    <div id="navigation-buttons" class="mt-8 pt-6 border-t border-slate-200 flex justify-between items-center">
                        <button id="prev-lesson-btn" class="px-4 py-2 text-sm font-semibold text-gray-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed">Lección Anterior</button>
                        <button id="main-action-btn" class="px-6 py-3 text-sm font-semibold text-white bg-simaq-blue rounded-lg shadow-sm hover:bg-simaq-dark-blue disabled:opacity-50 disabled:cursor-not-allowed">Marcar como completada</button>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURACIÓN DE FIREBASE PARA SIMAQ ---
            const firebaseConfig = {
                apiKey: "AIzaSyDfkx7XhbHIYqtRTTXjL9T-5qW5LenqYjI",
                authDomain: "simaq-2ed6c.firebaseapp.com",
                projectId: "simaq-2ed6c",
                storageBucket: "simaq-2ed6c.firebasestorage.app",
                messagingSenderId: "976543052975",
                appId: "1:976543052975:web:1b8d35f9a6d3b1cbb1d05a",
                measurementId: "G-1PRF6FG2YY"
            };
            
            try { firebase.initializeApp(firebaseConfig); } catch(e) { console.warn("Firebase ya fue inicializado."); }

            const auth = firebase.auth();
            const db = firebase.firestore();
            
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('course');
            
            // --- BASE DE DATOS DE CURSOS SIMAQ ---
            const ALL_COURSES_DATA = {
              'manejo-plaguicidas-sag': {
                title: 'Uso y Manejo de Plaguicidas (Credencial SAG)',
                totalLessons: 11,
                modules: [
                  {
                    title: 'Módulo 1: Fundamentos y Normativa',
                    lessons: [
                      { id: '1-1', title: 'Introducción al Manejo Seguro', type: 'video', videoUrl: 'https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4' },
                      { id: '1-2', title: 'Normativa SAG Aplicable', type: 'video', videoUrl: 'https://storage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4' },
                      { id: '1-3', title: 'Tipos de Plaguicidas y Etiquetas', type: 'video', videoUrl: 'https://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4' },
                      { id: 'q-1', title: 'Quiz: Fundamentos', type: 'quiz', questions: [
                          { text: 'La normativa SAG busca principalmente:', options: ['Aumentar la producción', 'Asegurar la inocuidad alimentaria y la seguridad del aplicador', 'Facilitar la exportación'], correctAnswer: 1 },
                          { text: 'La banda toxicológica de color rojo en una etiqueta indica:', options: ['Poco peligroso', 'Cuidado', 'Muy peligroso'], correctAnswer: 2 }
                      ]}
                    ]
                  },
                  {
                    title: 'Módulo 2: Equipos y Calibración',
                    lessons: [
                       { id: '2-1', title: 'Equipos de Protección Personal (EPP)', type: 'video', videoUrl: 'https://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerEscapes.mp4' },
                       { id: '2-2', title: 'Calibración de Equipos de Pulverización', type: 'video', videoUrl: 'https://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerFun.mp4' },
                       { id: 'q-2', title: 'Quiz: Equipos', type: 'quiz', questions: [
                           { text: '¿Qué elemento del EPP protege las vías respiratorias?', options: ['Guantes', 'Traje impermeable', 'Mascarilla con filtro'], correctAnswer: 2 },
                           { text: 'Una correcta calibración asegura:', options: ['Aplicar la dosis exacta del producto', 'Ahorrar tiempo', 'Usar menos agua'], correctAnswer: 0 },
                       ]}
                    ]
                  },
                  {
                    title: 'Módulo 3: Aplicación y Post-Aplicación',
                    lessons: [
                       { id: '3-1', title: 'Técnicas de Aplicación Segura', type: 'video', videoUrl: 'https://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4' },
                       { id: 'q-3', title: 'Quiz: Buenas Prácticas', type: 'quiz', questions: [
                           { text: 'El triple lavado de envases es una práctica para:', options: ['Reutilizar los envases', 'Eliminar residuos peligrosos antes de su desecho', 'Ahorrar producto'], correctAnswer: 1 },
                       ]}
                    ]
                  },
                  {
                    title: 'Módulo 4: Casos Prácticos y Evaluación Final',
                    lessons: [
                       { id: '4-1', title: 'Análisis de Casos Reales', type: 'video', videoUrl: 'https://storage.googleapis.com/gtv-videos-bucket/sample/WeAreGoingOnBullrun.mp4' },
                       { id: 'q-4', title: 'Evaluación Final del Curso', type: 'quiz', questions: [
                           { text: 'Ante un derrame de producto, ¿cuál es el primer paso a seguir?', options: ['Llamar a emergencias', 'Contener el derrame con material absorbente', 'Abandonar el área'], correctAnswer: 1 },
                           { text: 'El período de reingreso a un área tratada se encuentra especificado en:', options: ['La boleta de compra', 'La etiqueta del producto', 'El manual del tractor'], correctAnswer: 1 }
                       ]}
                    ]
                  }
                ]
              },
              'calibracion-pulverizacion': { title: 'Calibración de Equipos de Pulverización', totalLessons: 0, modules: [] },
              'manejo-carretillas': { title: 'Manejo y Operación de Carretillas Elevadoras', totalLessons: 0, modules: [] },
              'operacion-riego': { title: 'Operación y Mantenimiento de Equipos de Riego', totalLessons: 0, modules: [] },
              'operacion-tractores': { title: 'Operación y Mantenimiento de Tractores', totalLessons: 0, modules: [] }
            };

            // --- VARIABLES GLOBALES ---
            let currentUser = null;
            let courseData = null;
            let allLessons = [];
            let userProgress = { completedLessons: [], currentLessonId: null };

            // --- REFERENCIAS AL DOM ---
            const dom = {
                userName: document.getElementById('user-name'),
                logoutButton: document.getElementById('logout-button'),
                userProfile: document.getElementById('user-profile-container'),
                courseTitle: document.getElementById('course-title'),
                progressContainer: document.getElementById('progress-container'),
                modulesContainer: document.getElementById('modules-container'),
                lessonTitle: document.getElementById('lesson-title'),
                lessonMaterialContainer: document.getElementById('lesson-material-container'),
                navigationButtons: document.getElementById('navigation-buttons'),
                prevBtn: document.getElementById('prev-lesson-btn'),
                mainActionBtn: document.getElementById('main-action-btn'),
            };

            // --- FUNCIONES DE RENDERIZADO ---

            function displayError(message, details = '') {
                console.error(message, details);
                dom.courseTitle.textContent = "Ocurrió un Error";
                dom.lessonTitle.textContent = "Error al Cargar";
                dom.lessonMaterialContainer.innerHTML = `
                    <div class="text-center py-10">
                        <i data-lucide="alert-triangle" class="w-16 h-16 mx-auto text-red-500 mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800">${message}</h3>
                        <p class="mt-2 text-gray-600">Por favor, intenta recargar la página. Si el problema persiste, contacta a soporte.</p>
                        ${details ? `<pre class="mt-4 text-xs text-left bg-gray-100 p-2 rounded">${details}</pre>` : ''}
                    </div>`;
                dom.progressContainer.style.display = 'none';
                dom.navigationButtons.style.display = 'none';
                lucide.createIcons();
            }

            function renderCourseUnderConstruction() {
                dom.lessonTitle.textContent = "Curso en Construcción";
                dom.progressContainer.style.display = 'none';
                dom.navigationButtons.style.display = 'none';
                dom.lessonMaterialContainer.innerHTML = `
                    <div class="text-center py-10">
                        <i data-lucide="hard-hat" class="w-16 h-16 mx-auto text-yellow-500 mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800">¡Estamos preparando este curso!</h3>
                        <p class="mt-2 text-gray-600">El material para "${courseData.title}" estará disponible muy pronto.</p>
                    </div>`;
                dom.modulesContainer.innerHTML = `<p class="p-4 text-sm text-gray-500 text-center">El contenido se mostrará aquí.</p>`;
                lucide.createIcons();
            }

            function renderInitialCourseView() {
                if (!userProgress.currentLessonId && allLessons.length > 0) {
                    userProgress.currentLessonId = allLessons[0].id;
                }
                dom.progressContainer.style.display = 'block';
                dom.navigationButtons.style.display = 'flex';
                const lessonInfo = allLessons.find(l => l.id === userProgress.currentLessonId);
                if (lessonInfo) {
                    dom.lessonTitle.textContent = lessonInfo.title;
                    renderLessonContent(lessonInfo);
                }
                updateUIWithProgress();
            }
            
            function updateUIWithProgress() {
                renderSidebar();
                updateOverallProgress();
                updateMainActionButton();
                dom.prevBtn.disabled = allLessons.findIndex(l => l.id === userProgress.currentLessonId) === 0;
                lucide.createIcons();
            }

            function renderSidebar() {
                dom.modulesContainer.innerHTML = courseData.modules.map((module) => {
                    const lessonsHtml = module.lessons.map(lesson => {
                        const isCompleted = userProgress.completedLessons.includes(lesson.id);
                        const isActive = userProgress.currentLessonId === lesson.id;
                        const linkClasses = isActive ? 'bg-blue-50 text-simaq-blue font-semibold' : 'text-gray-600 hover:bg-slate-100';
                        const statusIcon = isCompleted ? 'check-circle-2' : 'circle';
                        const iconColor = isCompleted ? 'text-green-500' : 'text-slate-300';
                        return `
                            <li class="lesson-item" data-lesson-id="${lesson.id}">
                                <a href="#" class="flex items-center p-2 ml-2 rounded-md ${linkClasses}">
                                    <i data-lucide="${statusIcon}" class="h-5 w-5 mr-3 ${iconColor}"></i>
                                    <span class="flex-1 text-sm">${lesson.title}</span>
                                </a>
                            </li>`;
                    }).join('');
                    return `<div class="py-2"><h3 class="font-semibold text-gray-800 px-3 mb-1">${module.title}</h3><ul class="space-y-1">${lessonsHtml}</ul></div>`;
                }).join('');
                addSidebarListeners();
            }
            
            function renderLessonContent(lesson) {
                let materialHtml = ''; 
                switch(lesson.type) { 
                    case 'video':
                        materialHtml = `<div class="aspect-video w-full rounded-xl overflow-hidden bg-black"><video controls class="w-full h-full object-cover" src="${lesson.videoUrl || ''}"></video></div>`;
                        break; 
                    case 'quiz':
                        const isQuizCompleted = userProgress.completedLessons.includes(lesson.id);
                        if (isQuizCompleted) {
                            materialHtml = `<p class="text-center p-4 bg-green-100 text-green-700 rounded-lg">Ya completaste este quiz.</p>`;
                        } else {
                            const questionsHtml = lesson.questions.map((q, qIndex) => {
                                const optionsHtml = q.options.map((opt, index) => `<div class="quiz-option border-2 border-slate-300 p-4 rounded-lg cursor-pointer hover:bg-slate-100" data-index="${index}">${opt}</div>`).join('');
                                return `<div class="space-y-4 mb-8" data-question-index="${qIndex}"><h3 class="text-xl font-semibold">${qIndex + 1}. ${q.text}</h3><div class="space-y-3">${optionsHtml}</div></div>`;
                            }).join('');
                            materialHtml = `<div id="quiz-container">${questionsHtml}<button id="check-quiz-btn" class="mt-4 bg-gray-800 text-white font-semibold px-6 py-3 rounded-lg hover:bg-gray-900">Verificar Respuestas</button></div>`;
                        }
                        break;
                    default: 
                        materialHtml = `<p>Contenido no disponible.</p>`;
                } 
                dom.lessonMaterialContainer.innerHTML = materialHtml; 

                if (lesson.type === 'quiz' && !userProgress.completedLessons.includes(lesson.id)) {
                    dom.lessonMaterialContainer.querySelectorAll('.quiz-option').forEach(opt => {
                        opt.addEventListener('click', () => {
                            const questionContainer = opt.closest('[data-question-index]');
                            questionContainer.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
                            opt.classList.add('selected');
                        });
                    });
                    document.getElementById('check-quiz-btn').addEventListener('click', () => checkQuizAnswers(lesson));
                }
            }

            // --- LÓGICA DEL CURSO Y PROGRESO ---

            async function completeLesson(lessonId) {
                if (!userProgress.completedLessons.includes(lessonId)) {
                    userProgress.completedLessons.push(lessonId);
                    await saveProgress();
                    const currentIndex = allLessons.findIndex(l => l.id === lessonId);
                    if (currentIndex < allLessons.length - 1) {
                        navigateToLesson(allLessons[currentIndex + 1].id);
                    } else {
                        alert("¡Felicidades! Has completado el curso.");
                        updateUIWithProgress();
                    }
                }
            }

            function checkQuizAnswers(lesson) {
                let correctCount = 0;
                let allAnswered = true;
                lesson.questions.forEach((q, qIndex) => {
                    const container = dom.lessonMaterialContainer.querySelector(`[data-question-index="${qIndex}"]`);
                    const selected = container.querySelector('.quiz-option.selected');
                    if (!selected) {
                        allAnswered = false;
                    } else if (parseInt(selected.dataset.index) === q.correctAnswer) {
                        correctCount++;
                    }
                });
                if (!allAnswered) {
                    alert('Por favor, responde todas las preguntas.');
                    return;
                }
                if (correctCount === lesson.questions.length) {
                    alert('¡Excelente! Todas las respuestas son correctas.');
                    completeLesson(lesson.id);
                } else {
                    alert(`Tienes ${correctCount} de ${lesson.questions.length} respuestas correctas. Inténtalo de nuevo.`);
                }
            }
            
            function updateMainActionButton() {
                const lesson = allLessons.find(l => l.id === userProgress.currentLessonId);
                if (!lesson) return;
                const isCompleted = userProgress.completedLessons.includes(lesson.id);
                dom.mainActionBtn.disabled = lesson.type === 'quiz' || isCompleted;
                dom.mainActionBtn.textContent = isCompleted ? 'Completada' : 'Marcar como completada';
            }

            function updateOverallProgress() { 
                const percentage = allLessons.length > 0 ? Math.round((userProgress.completedLessons.length / courseData.totalLessons) * 100) : 0;
                document.getElementById('progress-bar').style.width = `${percentage}%`;
                document.getElementById('progress-text').textContent = `${percentage}%`; 
            }
            
            async function navigateToLesson(lessonId) {
                userProgress.currentLessonId = lessonId;
                await saveProgress();
                renderInitialCourseView();
            }

            async function saveProgress() { 
                if (!currentUser) return; 
                const progressRef = db.collection('userProgress').doc(currentUser.uid); 
                await progressRef.set({ [courseId]: userProgress }, { merge: true }); 
            }
            
            async function loadAndApplyUserProgress() { 
                try {
                    const docRef = db.collection('userProgress').doc(currentUser.uid);
                    const doc = await docRef.get();
                    if (doc.exists && doc.data()[courseId]) { 
                        const loadedProgress = doc.data()[courseId];
                        userProgress.completedLessons = Array.isArray(loadedProgress.completedLessons) ? loadedProgress.completedLessons : [];
                        userProgress.currentLessonId = allLessons.some(l => l.id === loadedProgress.currentLessonId) ? loadedProgress.currentLessonId : allLessons[0].id;
                    }
                } catch (error) {
                    console.warn("No se pudo cargar el progreso. Se mostrará el curso desde el inicio.", error);
                } finally {
                    updateUIWithProgress();
                }
            }
            
            function addSidebarListeners() {
                dom.modulesContainer.querySelectorAll('.lesson-item a').forEach(link => {
                    link.addEventListener('click', e => {
                        e.preventDefault();
                        const lessonId = e.currentTarget.closest('.lesson-item').dataset.lessonId;
                        navigateToLesson(lessonId);
                    });
                });
            }
            
            // --- INICIALIZACIÓN ---
            
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = { uid: user.uid, name: user.displayName || 'Alumno' };
                    dom.userName.textContent = currentUser.name;
                    dom.userProfile.classList.remove('hidden');
                    dom.userProfile.classList.add('flex');

                    try {
                        if (!courseId || !ALL_COURSES_DATA[courseId]) {
                            throw new Error("ID de curso no válido en la URL.");
                        }
                        
                        courseData = ALL_COURSES_DATA[courseId];
                        allLessons = courseData.modules.flatMap(m => m.lessons);
                        dom.courseTitle.textContent = courseData.title;

                        if (allLessons.length === 0) {
                            renderCourseUnderConstruction();
                        } else {
                            renderInitialCourseView();
                            loadAndApplyUserProgress();
                        }
                    } catch (error) {
                        displayError("No se pudo inicializar el curso", error.message);
                    }

                } else {
                    window.location.href = 'acceso-simaq.html';
                }
            });

            dom.logoutButton.addEventListener('click', () => auth.signOut().then(() => window.location.href = 'index.html'));
            dom.mainActionBtn.addEventListener('click', () => completeLesson(userProgress.currentLessonId));
            dom.prevBtn.addEventListener('click', () => { 
                const currentIndex = allLessons.findIndex(l => l.id === userProgress.currentLessonId); 
                if (currentIndex > 0) navigateToLesson(allLessons[currentIndex - 1].id); 
            });
        });
    </script>
</body>
</html>

